<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <title>Getting Started - Whip</title> <meta name=description content="A getting started guide"/> <link href="../assets/stylesheets/application-6771d460.css" rel=stylesheet /> <link rel=stylesheet href="//cdnjs.cloudflare.com/ajax/libs/hopscotch/0.2.6/css/hopscotch.min.css"> <meta name=viewport content="width=device-width, initial-scale=1.0"/> <link rel="shortcut icon" href="../assets/images/favicon-e9623b04.png"> <script src="//cdnjs.cloudflare.com/ajax/libs/hopscotch/0.2.6/js/hopscotch.min.js"></script> <script src="//use.typekit.net/kgv0shi.js"></script> <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script> <script>try{Typekit.load();}catch(e){}</script> </head> <body class="page-Getting Started layout-docs page-sub"> <div id=header class="navigation navbar-static-top"> <div class=container> <div class=row> <div class=col-xs-12> <div class=navbar-header> <div class=navbar-brand> <a class=logo href="../index.html">Whip</a> </div> <button class="navbar-toggle white" type=button> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> </div> <div class="buttons hidden-xs"> <nav class=navigation-links role=navigation> <ul class="external-links white nav navbar-nav navbar-right"> <li class=github> <a href="https://github.com/wayetender/whip"><svg id=svg-download xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;"> <path d="M13,0H1C0.5,0,0,0.5,0,1v12c0,0.5,0.5,1,1,1h4.7c0,0,0,0,0-0.1c0-0.2,0-0.6,0-1.1c-1.8,0.4-2.2-0.9-2.2-0.9 c-0.3-0.8-0.7-1-0.7-1c-0.6-0.4,0-0.4,0-0.4c0.7,0,1,0.7,1,0.7c0.6,1,1.5,0.7,1.9,0.5c0.1-0.4,0.2-0.7,0.4-0.9c-1.5-0.2-3-0.7-3-3.2 c0-0.7,0.3-1.3,0.7-1.8C3.7,5.8,3.5,5.1,3.9,4.2c0,0,0.6-0.2,1.8,0.7c0.5-0.1,1.1-0.2,1.6-0.2c0.6,0,1.1,0.1,1.6,0.2 c1.3-0.8,1.8-0.7,1.8-0.7c0.4,0.9,0.1,1.6,0.1,1.7c0.4,0.5,0.7,1,0.7,1.8c0,2.5-1.5,3.1-3,3.2C8.7,11.1,9,11.5,9,12.1 c0,0.9,0,1.6,0,1.8c0,0,0,0,0,0.1h4c0.5,0,1-0.5,1-1V1C14,0.5,13.5,0,13,0z"/> </svg> GitHub</a> </li> </ul> <ul class="main-links white nav navbar-nav navbar-right"> <li class=li-under><a href="index.html">Documentation</a></li> </ul> <ul class="main-links white nav navbar-nav navbar-right"> <li class=li-under><a href="https://katacoda.com/wayetender/scenarios/whip-calculator-quickstart">Demo</a></li> </ul> </nav> </div> </div> </div> </div> </div> <div class=sidebar-overlay></div> <aside id=sidebar class="sidebar sidebar-default sidebar-fixed-right" role=navigation> <div class="sidebar-header header-cover"> <div class=sidebar-image> <img src="../assets/images/favicon-e9623b04.png" width=50px height=50px> </div> </div> <ul class="main nav sidebar-nav"> <li class=first><a href="https://katacoda.com/wayetender/scenarios/whip-calculator-quickstart">Demo</a></li> <li class=""><a href="index.html">Docs</a></li> <li class=github><a href="https://github.com/wayetender/whip"><svg id=svg-download xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;"> <path d="M13,0H1C0.5,0,0,0.5,0,1v12c0,0.5,0.5,1,1,1h4.7c0,0,0,0,0-0.1c0-0.2,0-0.6,0-1.1c-1.8,0.4-2.2-0.9-2.2-0.9 c-0.3-0.8-0.7-1-0.7-1c-0.6-0.4,0-0.4,0-0.4c0.7,0,1,0.7,1,0.7c0.6,1,1.5,0.7,1.9,0.5c0.1-0.4,0.2-0.7,0.4-0.9c-1.5-0.2-3-0.7-3-3.2 c0-0.7,0.3-1.3,0.7-1.8C3.7,5.8,3.5,5.1,3.9,4.2c0,0,0.6-0.2,1.8,0.7c0.5-0.1,1.1-0.2,1.6-0.2c0.6,0,1.1,0.1,1.6,0.2 c1.3-0.8,1.8-0.7,1.8-0.7c0.4,0.9,0.1,1.6,0.1,1.7c0.4,0.5,0.7,1,0.7,1.8c0,2.5-1.5,3.1-3,3.2C8.7,11.1,9,11.5,9,12.1 c0,0.9,0,1.6,0,1.8c0,0,0,0,0,0.1h4c0.5,0,1-0.5,1-1V1C14,0.5,13.5,0,13,0z"/> </svg> GitHub</a></li> </ul> <div class=divider></div> <ul class="external nav sidebar-nav"> <li class=""><a class="v-btn gray sml" href="/" %>GitHub</a></li> </ul> </aside> <div class=container> <div class=col-md-4> <div class="docs-sidebar hidden-print affix-top" role=complementary> <ul class="nav docs-sidenav"> <li> <a href="index.html">Home</a> </li> <li class=active> <a href="getting-started.html">Getting Started</a> </li> <li> <a href="benchmarks.html">Benchmarks</a> </li> </ul> </div> </div> <div id=main-content class=col-md-8 role=main> <div class=bs-docs-section> <h1 id=getting-started> <a name=getting-started class=anchor href="#getting-started">&raquo;</a> Getting Started </h1> <p>We will highlight the features of Whip with a simple tutorial for the features of Whip with a simple microservices application.</p> <div class="alert alert-success" role=alert> <p><strong>Tired of switching between tutorial documentation and your terminal?</strong> Try using the online version of this demo at <a href="https://katacoda.com/wayetender/scenarios/whip-calculator-quickstart">Katacoda</a>!</p> </div> <p>In particular, it will highlight:</p> <ol> <li>Whip can be deployed on an application with no code changes. Additionally, Whip can operate under partial deployment (i.e., only one of the services will have a Whip adapter). </li> <li>Whip can detect first-order contract failures. </li> <li>Whip can detect higher-order contract failures. Whip blames correctly. Under partial deployment though, Whip uses the same blame label for all non Whip-enhanced services. </li> <li>Whip leverages other adapters in enhanced communication to transmit blame labels for services. </li> <li>Whip can detect indexed contract violations. </li> </ol> <h3 id=prerequisites> <a name=prerequisites class=anchor href="#prerequisites">&raquo;</a> Prerequisites </h3> <p>To run the benchmarks, you will need to have a recent version of Docker installed on your computer. The artifact was developed using Docker version 17.03.1-ce, build c6d412e. For instructions on downloading and installing Docker, please see <a href="https://www.docker.com/get-docker">https://www.docker.com/get-docker</a>.</p> <p>You must also be comfortable using a UNIX-like terminal with a modern shell (e.g., bash). Though the steps should reasonably work on a Windows-based operating system (as most of the functionality of Whip is contained in a Docker container), it has not been tested on one.</p> <h3 id=calculator-app> <a name=calculator-app class=anchor href="#calculator-app">&raquo;</a> Calculator App </h3> <p>The microservices application is a simple distributed calculator. It consists of three services: an <em>adder</em>, which performs numeric addition (which you could imagine being an extremely computationally expensive operation that must be distributed), a <em>discovery</em> service for adders, and a <em>client</em> which issues addition commands. The workflow of the application is:</p> <ol> <li>An adder joins the set of available adders by invoking the <code>register_adder</code> operation on the adder service that includes the address where the adder can be invoked. </li> <li>A client requests the address of an available adder by invoking the <code>get_adder_info</code>. The discovery service returns a random available adder to the client. </li> <li>With the given adder service address, the client invokes the <code>add</code> operation on the adder. The adder performs the computation and returns the result to the client. </li> </ol> <p>The source code for this application is in the <code>whip-calculator-example</code>. The Thrift network protocol is defined in <code>src/calc.thrift</code>.</p> <p>The first step is to build the containers. This can be done with the <code>docker-compose build</code> command.</p> <pre class="highlight plaintext"><code>$ docker-compose build
Building adder
...
</code></pre><p>We can then run the client by using the <code>docker-compose run client</code> command. When run, we will be presented with the calculator client. This command will also start up the adder and discovery service. For now, let&#39;s just use the <code>quit</code> command.</p> <pre class="highlight plaintext"><code>$ docker-compose run client
Creating whipcalculatorexample_adder_1
Creating whipcalculatorexample_discovery_1
connected to discovery service discovery:8000
Available Commands:
add [n1] [n2]                   - Get a random adder and compute n1+n2
register_adder [host] [port]    - Register new adder service
quit                            - Exits the program
&gt; quit
</code></pre><p>We can use the <code>logs</code> docker-compose command to check the status of the adder and discovery service.</p> <pre class="highlight plaintext"><code>$ docker-compose logs 
Attaching to whipcalculatorexample_discovery_1, whipcalculatorexample_adder_1
adder_1      | 05/14/2017 12:25:49 PM INFO adder service listening on 8001
adder_1      | 05/14/2017 12:25:49 PM INFO registered with adder discovery on discovery:8000 as adder-8001
discovery_1  | 05/14/2017 12:25:46 PM INFO adder discovery service listening on 7999
discovery_1  | 05/14/2017 12:25:49 PM DEBUG registering adder service adder:8001
</code></pre><p>Note that the adder and discovery services are still running. To view their status, run the <code>docker-compose ps</code> command. To stop them, run <code>docker-compose down</code>.</p> <pre class="highlight plaintext"><code>$ docker-compose ps
              Name                       Command         State                        Ports                       
-----------------------------------------------------------------------------------------------------------------
whipcalculatorexample_adder_1       ./run_adder.sh       Up      0.0.0.0:38001-&gt;38001/tcp, 0.0.0.0:8001-&gt;8001/tcp 
whipcalculatorexample_discovery_1   ./run_discovery.sh   Up      0.0.0.0:38000-&gt;38000/tcp, 0.0.0.0:8000-&gt;8000/tcp 
$ docker-compose down
Stopping whipcalculatorexample_discovery_1 ... done
Stopping whipcalculatorexample_adder_1 ... done
Removing whipcalculatorexample_client_run_1 ... done
Removing whipcalculatorexample_discovery_1 ... done
Removing whipcalculatorexample_adder_1 ... done
Removing network whipcalculatorexample_default
</code></pre><p>Let&#39;s now run the client to perform the third step of the workflow.</p> <pre class="highlight plaintext"><code>% docker-compose run client
connected to discovery service discovery:8000
Available Commands:
add [n1] [n2]                   - Get a random adder and compute n1+n2
register_adder [host] [port]    - Register new adder service
quit                            - Exits the program
&gt; add 2 2
2 + 2 = 3
&gt; quit
$
</code></pre><p><em>Uh oh.</em> Two plus two does not equal three. Let&#39;s use Whip to pinpoint the error. (Though, it should be no surprise, the adder has not held up its part of the bargain to perform the addition correctly.)</p> <h2 id=installing-a-whip-adapter> <a name=installing-a-whip-adapter class=anchor href="#installing-a-whip-adapter">&raquo;</a> Installing a Whip Adapter </h2> <p>We will start by installing an adapter on the client to catch the error.</p> <p>To do this we will need a Whip contract and a Whip adapter configuration. For the tutorial, we have provided both: the contract is located in <code>whip/calculator.whip</code> and the configuration file for the client is located in <code>adapter_client.yaml</code>.</p> <p>Of particular interest in the client proxy string:</p> <pre class="highlight plaintext"><code>  - discovery:8000 mapstoservice AdderDiscovery
</code></pre><p>This states that that there is an <code>AdderDiscovery</code> service at the <code>discovery</code> host with port <code>8000</code>.</p> <p>In order to deploy the client with the Whip adater with the above configuration, we need to create an adapter and use the shim library on the client. The <code>shim</code> command is a shell script that instructs the operating system to preload the interposition library to intercept on new network connections.</p> <p>The entry point of the client application is in the <code>run_client.sh</code> script. Inspecting the file, we can see that the adapter is already created in the first line of the script. The only remaining step is to add the shim library. We can do that by modifying the last line of the <code>run_client.sh</code> script from:</p> <pre class="highlight plaintext"><code>python src/client.py discovery 8000
</code></pre><p>to</p> <pre class="highlight plaintext"><code>shim python src/client.py discovery 8000
</code></pre><p>This will successfully install the Whip adapter on the client, without any code changes to the client itself.</p> <p>With the adapter installed we can bring down the application, rebuild the containers (note: not the service applications themselves), and run the client again:</p> <pre class="highlight plaintext"><code>$ docker-compose down
...
$ docker-compose build
...
$ docker-compose run cient
...
$ docker-compose run client ./run_client.sh
connected to discovery service discovery:8000
Available Commands:
add [n1] [n2]                   - Get a random adder and compute n1+n2
register_adder [host] [port]    - Register new adder service
quit                            - Exits the program
&gt; add 2 2
[Whip] Contract Failure: Failed postcondition  result == a + b 
     Occurring at: service Adder with default index at adder:8001 vouched for by unknown
     Variables: 
       - a = 2
       - b = 2
       - result = 3
2 + 2 = 3
&gt; 
</code></pre><p>Success! I mean, failure! We have a contract failure, that is. We have successfully captured a first-order contract failure (i.e., that <code>2 + 2</code> is not equal to <code>3</code>).</p> <p>Note the line coming from the error:</p> <pre class="highlight plaintext"><code>Occurring at: service Adder with default index at adder:8001 vouched for by unknown
</code></pre><p>In this line, we can see that the error came from the adder service. By inspecting the <code>adapter_client.yaml</code> file, we can see that the client is not initially configured to know about the location of adder service. Instead, Whip only knows about the adder service through the call to <code>get_adder_info</code>. (If you are curious, you can remove the <code>@identifies</code> tag for the <code>get_adder_info</code> Whip contract and the contract would not be checked.)</p> <p>Additionally, the service was <code>vouched for by unknown</code>. That is, the imprecise blame label was used.</p> <h3 id=enhanced-communication> <a name=enhanced-communication class=anchor href="#enhanced-communication">&raquo;</a> Enhanced Communication </h3> <p>We now install an adapter on all services. It turns out that the other services were already enhanced and we only need to make the client aware of the discovery service (which can be confirmed by inspecting the <code>run_adder.sh</code> and <code>run_discovery.sh</code> scripts). We can make the client aware of the discovery Whip adapter with a simple configuration change for the client adapters.</p> <p>Change the last line of <code>adapter_client.yaml</code> file from</p> <pre class="highlight plaintext"><code>  - discovery:8000 mapstoservice AdderDiscovery
</code></pre><p>to:</p> <pre class="highlight plaintext"><code>  - discovery:8000 proxiedby discovery:38000 mapstoservice AdderDiscovery
</code></pre><p>With this we can bring down the application, rebuild the containers (note: not the applications themselves), and run the client again:</p> <pre class="highlight plaintext"><code>$ docker-compose down
...
$ docker-compose build
...
$ % docker-compose run client
Creating network "whipcalculatorexample_default" with the default driver
Creating whipcalculatorexample_adder_1
Creating whipcalculatorexample_discovery_1
connected to discovery service discovery:8000
Available Commands:
add [n1] [n2]                   - Get a random adder and compute n1+n2
register_adder [host] [port]    - Register new adder service
quit                            - Exits the program
&gt; add 2 2
[Whip] Contract Failure: Failed postcondition  result == a + b 
     Occurring at: service Adder with default index at adder:8001 vouched for by adder
     Variables: 
       - a = 2
       - b = 2
       - result = 3

2 + 2 = 3
&gt; quit
</code></pre><p>We can see now in this case the adder service was vouched for by the adder adapter (the name &quot;adder&quot; comes from the <code>whip/adapter_adder.yaml</code> configuration file).</p> <h3 id=indexed-contracts> <a name=indexed-contracts class=anchor href="#indexed-contracts">&raquo;</a> Indexed Contracts </h3> <p>We show how Whip tracks indexed contracts with a special indexed contract form given in <code>whip/calculator.indexed.whip</code>. This indexed contract provides adder services only when the first operand (<code>a</code>) is exactly equal to 1. In all other cases, the adder service and discovery service do not vouch for its behavior. In other words, if the client provides an <code>a</code> operand to the adder that is not exactly <code>1</code> then it will vouch for the behavior of the adder service.</p> <p>Modify each Whip configuration file (<code>adapter_adder.yaml</code>, <code>adapter_client.yaml</code>, and <code>adapter_discovery.yaml</code>) to have the <code>spec</code> field be <code>whip/calculator.indexed.whip</code> instead of <code>whip/calculator.whip</code>.</p> <p>Once the configuration files are modified, we can rebuild the containers and try running the client with different arguments for <code>a</code>:</p> <pre class="highlight plaintext"><code>$ docker-compose down
...
$ docker-compose build
...
$ docker-compose run client
connected to discovery service discovery:8000
Available Commands:
add [n1] [n2]                   - Get a random adder and compute n1+n2
register_adder [host] [port]    - Register new adder service
quit                            - Exits the program
&gt; add 1 1
[Whip] Contract Failure: Failed postcondition  result == a + b 
     Occurring at: service Adder with index 1 at adder:8001 vouched for by adder
     Variables: 
       - a = 1
       - b = 1
       - result = 1

1 + 1 = 1
&gt; add 2 2
[Whip] Contract Failure: Failed postcondition  result == a + b 
     Occurring at: service Adder with index 2 at adder:8001 vouched for by client
     Variables: 
       - a = 2
       - b = 2
       - result = 3

2 + 2 = 3
&gt; quit
</code></pre><p>Note that the <code>adder</code> service was blamed in the first run but not in the second, as the client introduced the new Adder service in the second run (as <code>a</code> was not equal to 1).</p> <h4 id=bonus-fixing-the-adder-and-pre-condition-errors-> <a name=bonus-fixing-the-adder-and-pre-condition-errors- class=anchor href="#bonus-fixing-the-adder-and-pre-condition-errors-">&raquo;</a> Bonus (fixing the adder and pre-condition errors) </h4> <p>If you are so interested, you can also fix the broken adder by inspecting and modifing Line 18 of <code>src/adder.py</code>. Just change <code>return a + b - 1</code> to <code>return a + b</code>. By bringing down the services and bringing them back (as was done above), the error will go away.</p> <p>You can also see client-side errors as follows:</p> <pre class="highlight plaintext"><code>$ docker-compose down
...
$ docker-compose build
...
$ docker-compose run client
connected to discovery service discovery:8000
Available Commands:
add [n1] [n2]                   - Get a random adder and compute n1+n2
register_adder [host] [port]    - Register new adder service
quit                            - Exits the program
&gt; add 0 0
0 + 0 = 0
&gt; quit
$ docker-compose logs --tail 7 adder
Attaching to whipcalculatorexample_adder_1
adder_1      | [Whip] Contract Failure: Failed precondition for RPC add ( a &gt; 0 and b &gt; 0 )
adder_1      |   Blaming: client (precondition failure)
adder_1      |   Occurring at: service Adder with default index at adder:8001 vouched for by adder
adder_1      |   Variables: 
adder_1      |     - a = 0
adder_1      |     - b = 0
adder_1      | 
</code></pre><p>Note that in this case, the precondition error (providing a nonpositive integer) was caught in the <code>adder</code> service&#39;s Whip adapter. This is because when using enhanced communication adapters will share the burden of contract checking. Note though that still the client was blamed.</p> </div> </div> </div> <div id=footer class=navigation> <div class=container> <div class=row> <div class=col-xs-12> <div> <ul class="main-links white nav navbar-nav"> <li><a href="https://katacoda.com/wayetender/scenarios/whip-calculator-quickstart">Demo</a></li> </ul> <ul class="main-links white nav navbar-nav"> <li><a href="index.html">Documentation</a></li> </ul> <ul class="external-links white nav navbar-nav"> <li class=github> <a href="https://github.com/wayetender/whip"><svg id=svg-download xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;"> <path d="M13,0H1C0.5,0,0,0.5,0,1v12c0,0.5,0.5,1,1,1h4.7c0,0,0,0,0-0.1c0-0.2,0-0.6,0-1.1c-1.8,0.4-2.2-0.9-2.2-0.9 c-0.3-0.8-0.7-1-0.7-1c-0.6-0.4,0-0.4,0-0.4c0.7,0,1,0.7,1,0.7c0.6,1,1.5,0.7,1.9,0.5c0.1-0.4,0.2-0.7,0.4-0.9c-1.5-0.2-3-0.7-3-3.2 c0-0.7,0.3-1.3,0.7-1.8C3.7,5.8,3.5,5.1,3.9,4.2c0,0,0.6-0.2,1.8,0.7c0.5-0.1,1.1-0.2,1.6-0.2c0.6,0,1.1,0.1,1.6,0.2 c1.3-0.8,1.8-0.7,1.8-0.7c0.4,0.9,0.1,1.6,0.1,1.7c0.4,0.5,0.7,1,0.7,1.8c0,2.5-1.5,3.1-3,3.2C8.7,11.1,9,11.5,9,12.1 c0,0.9,0,1.6,0,1.8c0,0,0,0,0,0.1h4c0.5,0,1-0.5,1-1V1C14,0.5,13.5,0,13,0z"/> </svg> GitHub</a> </li> </ul> <ul class="external-links white nav navbar-nav navbar-right"> <li><a href="https://github.com/wayetender/whip/blob/master/web/source/docs/getting-started.md">Edit this page</a></li> </ul> </div> </div> </div> </div> </div> <script src="../assets/javascripts/application-d5bde7e6.js"></script> <!--[if lt IE 9]><script src="../assets/javascripts/ie-compat-c141a02d.js"></script><![endif]--> <script>
	APP.initialize();
</script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99314079-1', 'auto');
  ga('send', 'pageview');

</script> </body> </html>